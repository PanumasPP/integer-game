<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>โปรแกรมช่วยสอน: ปิ้งหมึกหรรษา</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Mitr:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --squid-size: 210px;
            --number-font-size: 2.8em;
            --number-margin-top: 110px;
        }

        html, body {
            height: 100%; width: 100%; margin: 0; padding: 0;
            overflow: hidden; font-family: 'Mitr', sans-serif; background-color: #000;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        #game-container {
            display: flex; flex-direction: column; justify-content: space-between;
            height: 100%; width: 100%; padding: 15px; box-sizing: border-box;
            background-image: url('BG.png'); 
            background-size: cover; background-position: center;
            color: white; text-shadow: 1px 1px 3px rgba(0,0,0,0.6); visibility: hidden;
            position: relative;
        }

        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #1a1a1a; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 200; color: white;
        }
        .spinner {
            width: 60px; height: 60px; border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%; border-top-color: #ffc107;
            animation: spin 1s ease-in-out infinite; margin-bottom: 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .control-btn-group {
            position: absolute; top: 20px; right: 20px;
            z-index: 110; display: flex; gap: 10px;
        }
        .control-btn {
            width: 40px; height: 40px; background: rgba(0,0,0,0.4);
            border: 2px solid white; border-radius: 50%; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            transition: transform 0.1s ease-out;
        }
        .control-btn:hover { transform: scale(1.1); }
        .control-btn:active { transform: scale(0.95); }

        #home-btn { 
            left: 20px; right: auto; display: none;
        }
        .control-btn svg { width: 20px; height: 20px; fill: white; }
        #mute-btn .unmuted-icon, #mute-btn.muted .muted-icon { display: block; }
        #mute-btn.muted .unmuted-icon, #mute-btn .muted-icon { display: none; }
        
        #fullscreen-btn .fs-enter-icon, #fullscreen-btn.fs-exit .fs-exit-icon { display: block; }
        #fullscreen-btn.fs-exit .fs-enter-icon, #fullscreen-btn .fs-exit-icon { display: none; }

        .screen-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.85); display: none;
            flex-direction: column; justify-content: center; align-items: center;
            z-index: 100; color: white; text-align: center; padding: 15px;
            box-sizing: border-box;
        }
        .screen-overlay.active { display: flex; }
        
        .overlay-content { background-color: transparent; max-width: 90%; }
        .overlay-title { font-size: 2.5em; color: #ffc107; margin-bottom: 20px;}
        .overlay-text { font-size: 1.2em; line-height: 1.6; text-align: left; }

        .selection-group {
            display: flex; flex-direction: column; align-items: center;
            gap: 15px; width: 100%;
        }
        .selection-group button, .action-button {
            font-family: 'Mitr', sans-serif; font-size: 1.3em;
            padding: 12px 30px; border-radius: 15px; border: none;
            cursor: pointer; transition: transform 0.2s;
            width: 280px; max-width: 90%;
        }
        .selection-group button:hover, .action-button:hover { transform: scale(1.05); }
        .selection-group button:active, .action-button:active { transform: scale(0.98); }

        #lesson-list {
            list-style: none; padding: 0; max-height: 60vh; overflow-y: auto;
            width: 100%; display: flex; flex-direction: column; align-items: center;
        }
        .lesson-item {
            display: flex; align-items: center; justify-content: center;
            background-color: #3498db; color: white; margin-bottom: 15px;
            padding: 15px; border-radius: 10px; cursor: pointer; width: 300px; max-width: 90%;
        }
        .lesson-item.locked {
            background-color: #7f8c8d; cursor: not-allowed; opacity: 0.7;
        }
        .lesson-item.locked .lock-icon { display: inline-block; }
        .lock-icon { display: none; margin-left: 10px; }

        .tutorial-box, .summary-box {
            background: rgba(44, 62, 80, 0.9);
            border: 2px solid #3498db;
            padding: 20px 30px; border-radius: 20px; max-width: 600px;
        }
        .summary-stars { font-size: 3em; color: #f1c40f; }
        
        #btn-lesson-mode { background-color: #2ecc71; color: white; }
        #btn-endless { background-color: #3498db; color: white; }
        #btn-challenge { background-color: #e74c3c; color: white; }
        #btn-easy { background-color: #2ecc71; color: white; }
        #btn-medium { background-color: #f1c40f; color: white; }
        #btn-hard { background-color: #c0392b; color: white; }
        .btn-green { background-color: #27ae60; color: white; }

        #countdown-display {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; justify-content: center; align-items: center;
            font-size: 25vh; font-weight: 700; color: #ffeb3b;
            text-shadow: 5px 5px 10px rgba(0,0,0,0.5); z-index: 150; pointer-events: none;
        }
        .countdown-pop { animation: countdown-pop 1s ease-out; }
        @keyframes countdown-pop {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        header { text-align: center; }
        h1 { color: #ffc107; margin: 0; padding: 0; font-size: 1.8em; }
        #info-bar { display: flex; justify-content: space-around; width: 100%; font-size: 1.2em; flex-wrap: wrap; }
        .score-pop { animation: pop 0.3s ease-out; }
        @keyframes pop { 50% { transform: scale(1.3); } }

        main#squid-area {
            flex-grow: 1; min-height: 200px; position: relative; width: 100%; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }
        .squid {
            width: var(--squid-size); height: calc(var(--squid-size) * 1.5);
            background-image: url('squid.png');
            background-size: contain; background-repeat: no-repeat;
            background-position: center; cursor: grab; display: flex;
            justify-content: center; align-items: flex-start;
            transition: opacity 0.3s, transform 0.3s;
            touch-action: none; 
            will-change: transform, opacity;
        }
        .squid-absolute { position: absolute; }
        .number-display {
            background-color: rgba(255, 255, 255, 0.9); color: #c0392b;
            text-shadow: none; font-size: var(--number-font-size);
            font-weight: 600; padding: 5px 15px; border-radius: 20px;
            border: 3px solid #c0392b; margin-top: var(--number-margin-top);
        }
        .spawn-anim { animation: spawn 0.4s ease-out; }
        @keyframes spawn { from { opacity: 0; transform: scale(0.5); } to { opacity: 1; transform: scale(1); } }
        
        .float-up { animation-name: float-up; animation-timing-function: linear; }
        @keyframes float-up {
            from { transform: translate(-50%, 120vh) rotate(-5deg); }
            to { transform: translate(-50%, -20vh) rotate(5deg); }
        }
        
        footer { text-align: center; }
        #feedback { font-size: 1.3em; font-weight: bold; min-height: 50px; display: flex; align-items: center; justify-content: center; padding: 0 10px; }
        #grill-section { display: flex; justify-content: space-evenly; align-items: center; gap: 20px; padding-bottom: 10px; }
        .grill { 
            border: 3px dashed transparent; border-radius: 15px; 
            transition: all 0.3s ease-in-out; 
            background-size: contain; background-position: center; background-repeat: no-repeat; 
            width: 30vw; max-width: 220px; height: 30vw; max-height: 220px; 
            position: relative; 
        }
        .grill-label {
            position: absolute; bottom: -40px; left: 50%;
            transform: translateX(-50%); font-size: 1.2em; width: 100%;
        }
        #grill-1 { background-image: url('grill-1.png'); }
        #grill-2 { background-image: url('grill-2.png'); }

        .drag-over { background-color: rgba(163, 228, 215, 0.5); border-style: solid; border-color: rgba(255,255,255,0.7); }
        .dragging { cursor: grabbing; opacity: 0.7; transform: scale(1.1) rotate(5deg); z-index: 50; }
        
        .squid-correct { animation: grill-and-cook 1.5s forwards; }
        @keyframes grill-and-cook {
            0% { transform: scale(1.1) rotate(0deg); opacity: 1; filter: none; }
            10% { transform: scale(1.15) rotate(-2deg); }
            20% { transform: scale(1.15) rotate(2deg); }
            30% { transform: scale(1.15) rotate(-2deg); filter: sepia(40%) saturate(2); }
            40% { transform: scale(1.15) rotate(2deg); }
            50% { transform: scale(1.15) rotate(0deg); filter: sepia(80%) saturate(3); }
            70% { transform: scale(1.2); filter: sepia(100%) saturate(4) blur(1px); opacity: 1;}
            100% { transform: scale(0.5); filter: sepia(100%) saturate(4) blur(1px); opacity: 0; }
        }

        .squid-wrong { animation: shake-it 0.5s; }
        @keyframes shake-it { 0%, 100% { transform: translateX(0); } 20% { transform: translateX(-15px) rotate(-5deg); } 40% { transform: translateX(15px) rotate(5deg); } 60% { transform: translateX(-10px) rotate(-3deg); } 80% { transform: translateX(10px) rotate(3deg); } }
        
        @media (max-width: 768px) {
            :root { --squid-size: 175px; --number-margin-top: 90px; }
            h1, .overlay-title { font-size: 1.8em; }
            #info-bar, .overlay-text { font-size: 1em; }
            .selection-group button, .action-button { width: 80%; font-size: 1.1em; }
        }

    </style>
</head>
<body>
    <div id="loading-screen"><div class="spinner"></div><p>กำลังโหลด...</p></div>

    <div id="game-container">
        <div id="countdown-display"></div>
        <div class="control-btn-group">
            <button id="home-btn" class="control-btn" title="กลับหน้าหลัก">
                <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
            </button>
            <button id="mute-btn" class="control-btn" title="ปิด/เปิดเสียง">
                <svg class="unmuted-icon" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
                <svg class="muted-icon" style="display: none;" viewBox="0 0 24 24"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>
            </button>
            <button id="fullscreen-btn" class="control-btn" title="โหมดเต็มหน้าจอ">
                <svg class="fs-enter-icon" viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
                <svg class="fs-exit-icon" style="display: none;" viewBox="0 0 24 24"><path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"/></svg>
            </button>
        </div>

        <div id="welcome-credit-screen" class="screen-overlay active">
            <div class="overlay-content" style="text-align: center;">
                <h2 class="overlay-title">โปรแกรมช่วยสอน: ปิ้งหมึกหรรษา</h2>
                <p style="font-size: 1.2em; margin-top: 40px;">จัดทำโดย</p>
                <h3 style="font-size: 1.8em; color: #ffeb3b; margin: 10px 0;">นางสาวกฤษณา แกล้วกล้า</h3>
                <p style="font-size: 1.2em;">ครูโรงเรียนสวนป่าอุปถัมภ์</p>
                <p style="margin-top: 50px; color: #ccc;">กำลังเข้าสู่เกมในอีกสักครู่...</p>
            </div>
        </div>

        <div id="register-screen" class="screen-overlay">
            <div class="overlay-content">
               <h2 class="overlay-title">ลงทะเบียน</h2>
                <div class="selection-group">
                    <p style="font-size: 1.1em; margin-bottom: 15px;">กรุณาใส่ชื่อของคุณเพื่อเริ่มเล่นและเก็บคะแนน</p>
                    <input type="text" id="player-name-input" placeholder="ใส่ชื่อที่นี่..." style="font-family: 'Mitr', sans-serif; font-size: 1.2em; padding: 10px; border-radius: 10px; border: 2px solid #3498db; width: 280px; max-width: 80%; text-align: center;">
                    <button id="btn-start-register" class="action-button btn-green" style="margin-top: 15px;">เริ่มเล่น</button>
                </div>
            </div>
        </div>
        
        <div id="main-menu-screen" class="screen-overlay">
            <div class="overlay-content">
                <h2 id="main-menu-title" class="overlay-title">โปรแกรมช่วยสอน: ปิ้งหมึกหรรษา</h2>
                <div class="selection-group">
                    <button id="btn-lesson-mode">โหมดบทเรียน</button>
                    <button id="btn-endless">โหมดฝึกฝน (ปกติ)</button>
                    <button id="btn-challenge">โหมดฝึกฝน (ท้าทาย)</button>
                </div>
            </div>
        </div>
        
        <div id="lesson-select-screen" class="screen-overlay">
            <div class="overlay-content">
                <h2 id="lesson-select-title" class="overlay-title">เลือกบทเรียน</h2>
                <ul id="lesson-list"></ul>
            </div>
        </div>
        
        <div id="difficulty-selection-screen" class="screen-overlay">
            <div class="overlay-content">
                <h2 id="difficulty-select-title" class="overlay-title">เลือกระดับความยาก</h2>
                <div id="difficulty-selection" class="selection-group">
                    <button id="btn-easy">ง่าย</button>
                    <button id="btn-medium">ปานกลาง</button>
                    <button id="btn-hard">ยาก</button>
                </div>
            </div>
        </div>

        <div id="tutorial-screen" class="screen-overlay">
            <div class="overlay-content tutorial-box">
                <h2 id="tutorial-title" class="overlay-title"></h2>
                <div id="tutorial-body" class="overlay-text"></div>
                <button id="start-lesson-btn" class="action-button btn-green">เข้าใจแล้ว เริ่มเลย!</button>
            </div>
        </div>

        <div id="lesson-complete-screen" class="screen-overlay">
            <div class="overlay-content summary-box">
                <h2 id="summary-title" class="overlay-title"></h2>
                <p id="summary-accuracy" class="overlay-text"></p>
                <div id="summary-stars" class="summary-stars"></div>
                <p id="summary-feedback" class="overlay-text"></p>
                <div class="selection-group" id="summary-buttons">
                    <button id="retry-lesson-btn" class="action-button">ลองอีกครั้ง</button>
                    <button id="next-lesson-btn" class="action-button btn-green">บทเรียนถัดไป</button>
                    <button id="back-to-lessons-btn" class="action-button">กลับไปหน้าเลือกบทเรียน</button>
                </div>
            </div>
        </div>

        <header>
            <h1></h1>
            <div id="info-bar"></div>
        </header>

        <main id="squid-area"></main>

        <footer>
            <div id="feedback"></div>
            <div id="grill-section">
                <div id="grill-1" class="grill"><span class="grill-label"></span></div>
                <div id="grill-2" class="grill"><span class="grill-label"></span></div>
            </div>
        </footer>
    </div>
    
    <audio id="sfx-correct" src="sound/correct.mp3" preload="auto"></audio>
    <audio id="sfx-wrong" src="sound/wrong.mp3" preload="auto"></audio>
    <audio id="sfx-combo" src="sound/combo.mp3" preload="auto"></audio>
    <audio id="sfx-levelup" src="sound/levelup.mp3" preload="auto"></audio>
    <audio id="bgm" src="sound/background.mp3" loop preload="auto"></audio>
    
    <script>
        const imagesToLoad = ['BG.png', 'squid.png', 'grill-1.png', 'grill-2.png'];
        let imagesLoaded = 0;
        if (imagesToLoad.length === 0) {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('game-container').style.visibility = 'visible';
        } else {
            imagesToLoad.forEach(src => {
                const img = new Image();
                img.src = src;
                const processLoad = () => {
                    imagesLoaded++;
                    if (imagesLoaded === imagesToLoad.length) {
                        setTimeout(() => {
                            document.getElementById('loading-screen').style.display = 'none';
                            document.getElementById('game-container').style.visibility = 'visible';
                        }, 500);
                    }
                };
                img.onload = processLoad;
                img.onerror = () => {
                    console.error(`ไม่สามารถโหลดรูปภาพ: ${src}`);
                    processLoad();
                };
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // --- BUG FIX: ตรวจสอบอุปกรณ์ว่าเป็น touch screen หรือไม่ ---
            const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

            const CAI_CONFIG = {
                lessons: [
                    {
                        id: 'L01', title: 'บทที่ 1: เลขคู่-คี่ (1 หลัก)', questionsTotal: 10, passThreshold: 8,
                        grillLabels: { one: 'เลขคู่', two: 'เลขคี่' },
                        tutorialHTML: `<h5 style="color: #5dade2; text-align: center;">🔵 จำนวนคู่ คืออะไร?</h5><p>จำนวนคู่ คือ จำนวนที่สามารถแบ่งเป็น 2 ส่วนเท่า ๆ กันได้พอดี โดยไม่เหลือเศษเลย</p><p><strong>🟢 ลองนึกภาพดูสิ...</strong></p><p style="margin: 5px 0;">ถ้ามีลูกอม 4 เม็ด แล้วเราแบ่งให้เพื่อน 2 คน คนละเท่า ๆ กัน เพื่อนแต่ละคนจะได้ 2 เม็ด ไม่มีเหลือเลย!</p><hr><h5 style="color: #f1c40f; text-align: center;">🔴 จำนวนคี่ คืออะไร?</h5><p>จำนวนคี่ คือ จำนวนที่เมื่อแบ่งเป็น 2 ส่วนเท่า ๆ กัน จะเหลือ 1 เสมอ</p><p><strong>🟡 ลองนึกภาพอีกที...</strong></p><p style="margin: 5px 0;">ถ้ามีลูกอม 5 เม็ด แล้วจะแบ่งให้เพื่อน 2 คน คนละเท่า ๆ กัน จะได้ไปคนละ 2 เม็ด... แล้วจะเหลือลูกอม 1 เม็ด!</p><hr><div style="background-color: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; margin-top: 15px;"><h5 style="margin-top:0; text-align: center;">✋ วิธีจำง่าย ๆ</h5><p style="margin-bottom: 5px;"><strong>จำนวนคู่</strong> คือจำนวนที่ลงท้ายด้วย <strong>0, 2, 4, 6, 8</strong></p><p style="margin-bottom: 0;"><strong>จำนวนคี่</strong> คือจำนวนที่ลงท้ายด้วย <strong>1, 3, 5, 7, 9</strong></p></div>`,
                        problemGenerator: () => Math.floor(Math.random() * 10),
                        checkAnswer: (num, grillId) => (num % 2 === 0 && grillId === 'grill-1') || (num % 2 !== 0 && grillId === 'grill-2'),
                        getExplanation: (num, isCorrect) => {
                            const type = num % 2 === 0 ? 'เลขคู่' : 'เลขคี่';
                            return `<strong>${num}</strong> เป็น <strong>${type}</strong>` + (isCorrect ? ' ถูกต้อง!' : ' นะ');
                        }
                    },
                    {
                        id: 'L02', title: 'บทที่ 2: เลขคู่-คี่ (2 หลัก)', questionsTotal: 10, passThreshold: 8,
                        grillLabels: { one: 'เลขคู่', two: 'เลขคี่' },
                        tutorialHTML: `<p>เก่งมาก! ต่อไปเรามาลองกับเลข 2 หลักกัน</p><p>จำไว้ว่า... เราดูแค่ <strong>เลขตัวสุดท้าย</strong> เท่านั้น!</p>`,
                        problemGenerator: () => Math.floor(Math.random() * 90) + 10,
                        checkAnswer: (num, grillId) => (num % 2 === 0 && grillId === 'grill-1') || (num % 2 !== 0 && grillId === 'grill-2'),
                        getExplanation: (num, isCorrect) => {
                            const type = num % 2 === 0 ? 'เลขคู่' : 'เลขคี่';
                            const lastDigit = num % 10;
                            return `<strong>${num}</strong> เป็น <strong>${type}</strong> เพราะลงท้ายด้วยเลข <strong>${lastDigit}</strong>` + (isCorrect ? ' ถูกต้อง!' : ' นะ');
                        }
                    },
                    {
                        id: 'L03', title: 'บทที่ 3: เลขคู่-คี่ (3 หลัก)', questionsTotal: 10, passThreshold: 9,
                        grillLabels: { one: 'เลขคู่', two: 'เลขคี่' },
                        tutorialHTML: `<p>ด่านสุดท้ายแล้ว! เลขจะเยอะขึ้น แต่หลักการยังเหมือนเดิม</p><p>ไม่ต้องกลัวนะ... ดูแค่ <strong>เลขตัวสุดท้าย</strong> ก็พอ!</p>`,
                        problemGenerator: () => Math.floor(Math.random() * 900) + 100,
                        checkAnswer: (num, grillId) => (num % 2 === 0 && grillId === 'grill-1') || (num % 2 !== 0 && grillId === 'grill-2'),
                        getExplanation: (num, isCorrect) => {
                            const type = num % 2 === 0 ? 'เลขคู่' : 'เลขคี่';
                            const lastDigit = num % 10;
                            return `<strong>${num}</strong> เป็น <strong>${type}</strong> เพราะลงท้ายด้วยเลข <strong>${lastDigit}</strong>` + (isCorrect ? ' ถูกต้อง!' : ' นะ');
                        }
                    }
                ],
                practice: {
                    endless: { title: "โหมดปกติ", initialTime: 60, levelUpScore: 10, timeBonus: 5 },
                    challenge: {
                        title: "โหมดท้าทาย", duration: 60, numLanes: 4, horizontalMargin: 10,
                        difficulties: {
                            easy:   { name: "ง่าย", minSpawn: 1800, maxSpawn: 2500, floatDuration: 10 },
                            medium: { name: "ปานกลาง", minSpawn: 1200, maxSpawn: 2000, floatDuration: 8 },
                            hard:   { name: "ยาก", minSpawn: 800, maxSpawn: 1500, floatDuration: 6.5 }
                        }
                    }
                }
            };

            const dom = {
                gameContainer: document.getElementById('game-container'),
                squidArea: document.getElementById('squid-area'),
                feedback: document.getElementById('feedback'),
                grill1: document.getElementById('grill-1'),
                grill2: document.getElementById('grill-2'),
                grill1Label: document.querySelector('#grill-1 .grill-label'),
                grill2Label: document.querySelector('#grill-2 .grill-label'),
                welcomeCreditScreen: document.getElementById('welcome-credit-screen'),
                registerScreen: document.getElementById('register-screen'),
                playerNameInput: document.getElementById('player-name-input'),
                btnStartRegister: document.getElementById('btn-start-register'),
                mainMenuScreen: document.getElementById('main-menu-screen'),
                mainMenuTitle: document.getElementById('main-menu-title'),
                lessonSelectTitle: document.getElementById('lesson-select-title'),
                difficultySelectTitle: document.getElementById('difficulty-select-title'),
                btnLessonMode: document.getElementById('btn-lesson-mode'),
                btnEndless: document.getElementById('btn-endless'),
                btnChallenge: document.getElementById('btn-challenge'),
                lessonSelectScreen: document.getElementById('lesson-select-screen'),
                lessonList: document.getElementById('lesson-list'),
                difficultySelectionScreen: document.getElementById('difficulty-selection-screen'),
                btnEasy: document.getElementById('btn-easy'),
                btnMedium: document.getElementById('btn-medium'),
                btnHard: document.getElementById('btn-hard'),
                tutorialScreen: document.getElementById('tutorial-screen'),
                tutorialTitle: document.getElementById('tutorial-title'),
                tutorialBody: document.getElementById('tutorial-body'),
                startLessonBtn: document.getElementById('start-lesson-btn'),
                lessonCompleteScreen: document.getElementById('lesson-complete-screen'),
                summaryTitle: document.getElementById('summary-title'),
                summaryAccuracy: document.getElementById('summary-accuracy'),
                summaryStars: document.getElementById('summary-stars'),
                summaryFeedback: document.getElementById('summary-feedback'),
                retryLessonBtn: document.getElementById('retry-lesson-btn'),
                nextLessonBtn: document.getElementById('next-lesson-btn'),
                backToLessonsBtn: document.getElementById('back-to-lessons-btn'),
                homeBtn: document.getElementById('home-btn'),
                muteBtn: document.getElementById('mute-btn'),
                fullscreenBtn: document.getElementById('fullscreen-btn'),
                title: document.querySelector('h1'),
                infoBar: document.getElementById('info-bar'),
                countdownDisplay: document.getElementById('countdown-display'),
                bgm: document.getElementById('bgm'),
            };

            const sounds = { correct: document.getElementById('sfx-correct'), wrong: document.getElementById('sfx-wrong'),
                combo: document.getElementById('sfx-combo'), levelup: document.getElementById('sfx-levelup') };

            let userProgress = {};
            let score, level, timeLeft, gameTimer, isMuted = false, draggedElement = null, isGameActive = false;
            let currentGameMode = null, currentLesson = null, currentDifficulty = null;
            let currentQuestion, correctAnswers, spawnerTimeout;
            let currentPlayerName = '';

            const playSound = (key) => { if (!isMuted && sounds[key]) { sounds[key].currentTime = 0; sounds[key].play().catch(() => {}); } };
            const vibrate = (pattern) => { if (navigator.vibrate) navigator.vibrate(pattern); };
            
            function initializeGame() {
                setTimeout(() => {
                    dom.welcomeCreditScreen.style.display = 'none';
                    setupApplication();
                }, 4000);
            }

            function setupApplication() {
                dom.bgm.volume = 0.3;
                loadProgress();
                
                dom.btnLessonMode.addEventListener('click', showLessonSelect);
                dom.btnEndless.addEventListener('click', () => startGame('endless'));
                dom.btnChallenge.addEventListener('click', showDifficultySelection);
                dom.btnEasy.addEventListener('click', () => startGame('challenge', 'easy'));
                dom.btnMedium.addEventListener('click', () => startGame('challenge', 'medium'));
                dom.btnHard.addEventListener('click', () => startGame('challenge', 'hard'));
                dom.homeBtn.addEventListener('click', showMainMenu);
                dom.muteBtn.addEventListener('click', toggleMute);
                dom.fullscreenBtn.addEventListener('click', toggleFullScreen);
                dom.backToLessonsBtn.addEventListener('click', showLessonSelect);
                dom.btnStartRegister.addEventListener('click', registerPlayer);
                
                // --- Conditional Event Handlers ---
                if (isTouchDevice) {
                    initializeTouchEvents();
                } else {
                    initializeDragDrop();
                }

                showRegisterScreen();
            }

            function initializeTouchEvents() {
                let touchDraggedElement = null;
                let originalParent = null; 

                dom.gameContainer.addEventListener('touchstart', (e) => {
                    if (!isGameActive) return;
                    const targetSquid = e.target.closest('.squid');
                    if (targetSquid && !targetSquid.classList.contains('squid-correct')) {
                        e.preventDefault(); 
                        touchDraggedElement = targetSquid;
                        originalParent = targetSquid.parentNode;
                        document.body.appendChild(touchDraggedElement);
                        touchDraggedElement.style.position = 'absolute';
                        touchDraggedElement.style.zIndex = '1000';
                        touchDraggedElement.classList.add('dragging');
                        moveElementWithTouch(e);
                    }
                }, { passive: false });

                dom.gameContainer.addEventListener('touchmove', (e) => {
                    if (touchDraggedElement) {
                        e.preventDefault();
                        moveElementWithTouch(e);
                        
                        touchDraggedElement.style.visibility = 'hidden';
                        const touch = e.touches[0];
                        const elementUnderTouch = document.elementFromPoint(touch.clientX, touch.clientY);
                        touchDraggedElement.style.visibility = 'visible';
                        
                        [dom.grill1, dom.grill2].forEach(grill => {
                            if (grill === elementUnderTouch || grill.contains(elementUnderTouch)) {
                                grill.classList.add('drag-over');
                            } else {
                                grill.classList.remove('drag-over');
                            }
                        });
                    }
                }, { passive: false });

                dom.gameContainer.addEventListener('touchend', (e) => {
                    if (!touchDraggedElement) return;
                    e.preventDefault();
                    
                    touchDraggedElement.style.visibility = 'hidden';
                    const touch = e.changedTouches[0];
                    const elementUnderTouch = document.elementFromPoint(touch.clientX, touch.clientY);
                    touchDraggedElement.style.visibility = 'visible';
                    
                    let droppedOnGrill = null;
                    if (dom.grill1.contains(elementUnderTouch)) {
                        droppedOnGrill = dom.grill1;
                    } else if (dom.grill2.contains(elementUnderTouch)) {
                        droppedOnGrill = dom.grill2;
                    }

                    [dom.grill1, dom.grill2].forEach(g => g.classList.remove('drag-over'));
                    touchDraggedElement.classList.remove('dragging');
                    touchDraggedElement.style.position = '';
                    touchDraggedElement.style.zIndex = '';
                    touchDraggedElement.style.left = '';
                    touchDraggedElement.style.top = '';
                    
                    if (originalParent) {
                        originalParent.appendChild(touchDraggedElement);
                    }
                    
                    if (droppedOnGrill) {
                        if (currentGameMode === 'lesson') {
                            handleAnswer(touchDraggedElement, droppedOnGrill.id);
                        } else {
                            handlePracticeAnswer(touchDraggedElement, droppedOnGrill.id);
                        }
                    }
                    
                    touchDraggedElement = null;
                    originalParent = null;
                });

                function moveElementWithTouch(e) {
                    const touch = e.touches[0];
                    touchDraggedElement.style.left = (touch.clientX - touchDraggedElement.offsetWidth / 2) + 'px';
                    touchDraggedElement.style.top = (touch.clientY - touchDraggedElement.offsetHeight / 2) + 'px';
                }
            }

            function showRegisterScreen() {
                const savedName = localStorage.getItem('squid_player_name');
                if (savedName) {
                    currentPlayerName = savedName;
                    dom.playerNameInput.value = savedName;
                    if (!isMuted) { dom.bgm.play().catch(()=>{}); }
                    showMainMenu();
                } else {
                    showScreen('register-screen');
                }
            }

            function registerPlayer() {
                const name = dom.playerNameInput.value.trim();
                if (name === '') {
                    alert('กรุณาใส่ชื่อของคุณ!');
                    return;
                }
                currentPlayerName = name;
                localStorage.setItem('squid_player_name', name);
                
                if (!isMuted) dom.bgm.play().catch(()=>{});
                
                showMainMenu();
            }

            function loadProgress() {
                const saved = localStorage.getItem('squid_cai_progress_p2');
                userProgress = saved ? JSON.parse(saved) : { unlockedLessons: ['L01'], highScores: {} };
            }

            function saveProgress() {
                localStorage.setItem('squid_cai_progress_p2', JSON.stringify(userProgress));
            }
            
            function getLeaderboard(mode) {
                try {
                    const leaderboard = localStorage.getItem(`leaderboard_${mode}`);
                    return leaderboard ? JSON.parse(leaderboard) : [];
                } catch (e) { return []; }
            }

            function saveScoreToLeaderboard(mode, playerName, score) {
                if(!mode || mode === 'lesson') return;
                const leaderboard = getLeaderboard(mode);
                leaderboard.push({ name: playerName, score: score });
                leaderboard.sort((a, b) => b.score - a.score);
                const top10 = leaderboard.slice(0, 10);
                try {
                    localStorage.setItem(`leaderboard_${mode}`, JSON.stringify(top10));
                } catch (e) { console.error("ไม่สามารถบันทึก leaderboard:", e); }
            }

            function unlockNextLesson(currentLessonId) {
                const currentIndex = CAI_CONFIG.lessons.findIndex(l => l.id === currentLessonId);
                if (currentIndex > -1 && currentIndex < CAI_CONFIG.lessons.length - 1) {
                    const nextLessonId = CAI_CONFIG.lessons[currentIndex + 1].id;
                    if (!userProgress.unlockedLessons.includes(nextLessonId)) {
                        userProgress.unlockedLessons.push(nextLessonId);
                    }
                }
            }
            
            function showScreen(screenId) {
                document.querySelectorAll('.screen-overlay').forEach(s => s.classList.remove('active'));
                if (screenId) document.getElementById(screenId).classList.add('active');
                
                const isGameScreen = !screenId;
                dom.homeBtn.style.display = (screenId && screenId !== 'main-menu-screen' && screenId !== 'welcome-credit-screen' && screenId !== 'register-screen') || isGameScreen ? 'flex' : 'none';

                isGameActive = false;
                clearTimeout(spawnerTimeout);
                clearInterval(gameTimer);
            }

            function showMainMenu() {
                showScreen('main-menu-screen');
                dom.title.textContent = `ผู้เล่น: ${currentPlayerName}`;
                dom.infoBar.innerHTML = '';
                dom.feedback.innerHTML = 'เลือกโหมดที่ต้องการเล่นได้เลย!';
                dom.grill1Label.textContent = '';
                dom.grill2Label.textContent = '';
            }

            function showLessonSelect() {
                dom.lessonSelectTitle.textContent = "เลือกบทเรียน";
                const list = dom.lessonList;
                list.innerHTML = '';
                CAI_CONFIG.lessons.forEach(lesson => {
                    const isUnlocked = userProgress.unlockedLessons.includes(lesson.id);
                    const li = document.createElement('li');
                    li.className = `lesson-item ${isUnlocked ? '' : 'locked'}`;
                    li.innerHTML = `${lesson.title} <span class="lock-icon">🔒</span>`;
                    if (isUnlocked) li.addEventListener('click', () => startLesson(lesson.id));
                    list.appendChild(li);
                });
                showScreen('lesson-select-screen');
            }

            function showDifficultySelection() {
                dom.difficultySelectTitle.textContent = "เลือกระดับความยาก";
                showScreen('difficulty-selection-screen');
            }
            
            const toggleMute = () => {
                isMuted = !isMuted;
                dom.muteBtn.classList.toggle('muted', isMuted);
                dom.bgm.muted = isMuted;
                if (!isMuted) dom.bgm.play().catch(()=>{});
            };

            const toggleFullScreen = () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(() => {});
                } else if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            };

            document.addEventListener('fullscreenchange', () => {
                const isFullscreen = !!document.fullscreenElement;
                dom.fullscreenBtn.classList.toggle('fs-exit', isFullscreen);
            });


            function startGame(mode, difficulty = 'medium') {
                currentGameMode = mode;
                currentDifficulty = difficulty;
                
                showScreen(null);
                dom.feedback.innerHTML = '';
                
                startCountdown(() => {
                    isGameActive = true;
                    if (mode === 'lesson') playLesson();
                    else if (mode === 'endless') setupEndlessMode();
                    else if (mode === 'challenge') setupChallengeMode();
                });
            }

            function startCountdown(onComplete) {
                let count = 3;
                dom.countdownDisplay.style.display = 'flex';
                
                const updateAndShow = () => {
                    dom.countdownDisplay.classList.remove('countdown-pop');
                    void dom.countdownDisplay.offsetWidth;
                    if (count > 0) {
                        dom.countdownDisplay.textContent = count;
                        playSound('combo');
                    } else {
                        dom.countdownDisplay.textContent = 'GO!';
                        playSound('levelup');
                    }
                    dom.countdownDisplay.classList.add('countdown-pop');
                };

                const countdownInterval = setInterval(() => {
                    count--;
                    if (count < 0) {
                        clearInterval(countdownInterval);
                        dom.countdownDisplay.style.display = 'none';
                        onComplete();
                    } else {
                        updateAndShow();
                    }
                }, 1000);
                updateAndShow();
            }

            function endGame() {
                isGameActive = false;
                clearTimeout(spawnerTimeout);
                clearInterval(gameTimer);
                dom.squidArea.innerHTML = '';

                const modeKey = currentGameMode + (currentGameMode === 'challenge' ? `_${currentDifficulty}` : '');
                saveScoreToLeaderboard(modeKey, currentPlayerName, score);
                const leaderboard = getLeaderboard(modeKey);
                const playerRank = leaderboard.findIndex(entry => entry.name === currentPlayerName && entry.score === score) + 1;
                
                dom.summaryAccuracy.style.display = 'block';
                dom.backToLessonsBtn.style.display = 'none';
                dom.nextLessonBtn.style.display = 'none';
                dom.retryLessonBtn.style.display = 'inline-block';
                dom.retryLessonBtn.textContent = "กลับหน้าหลัก";
                dom.retryLessonBtn.onclick = showMainMenu;
                
                let highScoreKey = `highScore_${currentGameMode}` + (currentGameMode === 'challenge' ? `_${currentDifficulty}` : '');
                if (!userProgress.highScores) userProgress.highScores = {};
                let currentHighScore = userProgress.highScores[highScoreKey] || 0;

                dom.summaryTitle.textContent = "เกมจบแล้ว!";
                if (score > currentHighScore) {
                    userProgress.highScores[highScoreKey] = score;
                    saveProgress();
                    dom.summaryAccuracy.innerHTML = `สุดยอด! สถิติใหม่!<br>คะแนน: ${score}`;
                } else {
                    dom.summaryAccuracy.innerHTML = `ทำได้ ${score} คะแนน!<br>สถิติสูงสุดส่วนตัว: ${currentHighScore}`;
                }
                
                const rankText = playerRank > 0 ? `คุณอยู่อันดับที่ ${playerRank} ของเครื่องนี้` : 'พยายามอีกหน่อยนะ!';
                dom.summaryStars.style.fontSize = '1.5em'; 
                dom.summaryStars.textContent = rankText;
                
                dom.summaryFeedback.textContent = 'กลับไปที่หน้าหลักเพื่อเล่นอีกครั้ง';
                showScreen('lesson-complete-screen');
            }
            
            const updateTimer = () => {
                timeLeft--;
                const timerEl = document.getElementById('timer');
                if (timerEl) timerEl.textContent = timeLeft;
                if (timeLeft <= 0) {
                    timeLeft = 0;
                    if (timerEl) timerEl.textContent = timeLeft;
                    endGame();
                }
            };
            
            function setupPracticeModeGrills() {
                dom.grill1Label.textContent = "เลขคู่";
                dom.grill2Label.textContent = "เลขคี่";
            }

            function setupEndlessMode() {
                score = 0; level = 1;
                timeLeft = CAI_CONFIG.practice.endless.initialTime;
                setupPracticeModeGrills();
                updateHUD();
                generateSquidEndless();
                gameTimer = setInterval(updateTimer, 1000);
            }

            function setupChallengeMode() {
                score = 0;
                timeLeft = CAI_CONFIG.practice.challenge.duration;
                setupPracticeModeGrills();
                updateHUD();
                scheduleNextSquid(); 
                gameTimer = setInterval(updateTimer, 1000);
            }

            function startLesson(lessonId){
                currentLesson = CAI_CONFIG.lessons.find(l => l.id === lessonId);
                if(currentLesson) showTutorial();
            }

            function showTutorial() {
                dom.tutorialTitle.textContent = currentLesson.title;
                dom.tutorialBody.innerHTML = currentLesson.tutorialHTML;
                dom.startLessonBtn.onclick = () => startGame('lesson');
                showScreen('tutorial-screen');
            }

            function playLesson() {
                currentQuestion = 0;
                correctAnswers = 0;
                dom.grill1Label.textContent = currentLesson.grillLabels.one;
                dom.grill2Label.textContent = currentLesson.grillLabels.two;
                nextQuestion();
            }

            function nextQuestion() {
                if (!isGameActive) return;
                if (currentQuestion >= currentLesson.questionsTotal) {
                    isGameActive = false;
                    setTimeout(showLessonComplete, 500);
                    return;
                }
                currentQuestion++;
                updateHUD();
                dom.feedback.innerHTML = '';
                dom.squidArea.innerHTML = '';
                const number = currentLesson.problemGenerator();
                createSquid(number);
            }
            
            function updateHUD() {
                let titleText = '';
                let infoHTML = '';
                if(currentGameMode === 'lesson'){
                    titleText = currentLesson.title;
                    infoHTML = `<div>ข้อที่: ${currentQuestion}/${currentLesson.questionsTotal}</div> <div>ถูกต้อง: ${correctAnswers}</div>`;
                } else {
                    const modeTitle = CAI_CONFIG.practice[currentGameMode].title;
                    const diffName = currentGameMode === 'challenge' ? ` (${CAI_CONFIG.practice.challenge.difficulties[currentDifficulty].name})` : '';
                    titleText = `${currentPlayerName} | ${modeTitle}${diffName}`;

                    let highScoreKey = `highScore_${currentGameMode}` + (currentGameMode === 'challenge' ? `_${currentDifficulty}` : '');
                    if (!userProgress.highScores) userProgress.highScores = {};
                    let highScore = userProgress.highScores[highScoreKey] || 0;
                    infoHTML = `<div id="score-container">คะแนน: <span id="score">${score}</span></div> <div id="hiscore-container">สูงสุด: ${highScore}</div> <div id="timer-board">เวลา: <span id="timer">${timeLeft}</span></div>`;
                }
                dom.title.textContent = titleText;
                dom.infoBar.innerHTML = infoHTML;
            }

            function showLessonComplete() {
                const lesson = currentLesson;
                const accuracy = (correctAnswers / lesson.questionsTotal) * 100;
                const passed = correctAnswers >= lesson.passThreshold;
                
                let stars = passed ? (accuracy >= 95 ? '⭐⭐⭐' : (accuracy >= 80 ? '⭐⭐' : '⭐')) : '';
                dom.summaryStars.style.fontSize = '3em';
                dom.summaryTitle.textContent = passed ? "ยินดีด้วย คุณผ่านแล้ว!" : "พยายามอีกนิดนะ!";
                dom.summaryAccuracy.style.display = 'block';
                dom.summaryAccuracy.textContent = `ความแม่นยำ: ${accuracy.toFixed(0)}% (ตอบถูก ${correctAnswers} จาก ${lesson.questionsTotal} ข้อ)`;
                dom.summaryStars.textContent = stars;
                dom.summaryFeedback.textContent = passed ? "ไปต่อบทเรียนถัดไปได้เลย!" : "ลองทบทวนอีกครั้งนะ";
                
                if (passed) { unlockNextLesson(lesson.id); saveProgress(); }

                dom.retryLessonBtn.textContent = "ลองอีกครั้ง";
                dom.retryLessonBtn.onclick = () => startLesson(lesson.id);
                dom.retryLessonBtn.style.display = 'inline-block';
                
                const nextLessonIndex = CAI_CONFIG.lessons.findIndex(l => l.id === lesson.id) + 1;
                const hasNextLesson = nextLessonIndex < CAI_CONFIG.lessons.length;
                
                dom.nextLessonBtn.style.display = (passed && hasNextLesson) ? 'inline-block' : 'none';
                if(passed && hasNextLesson) {
                    const nextLesson = CAI_CONFIG.lessons[nextLessonIndex];
                     if (userProgress.unlockedLessons.includes(nextLesson.id)) {
                        dom.nextLessonBtn.onclick = () => startLesson(nextLesson.id);
                    }
                }
                dom.backToLessonsBtn.style.display = 'inline-block';
                showScreen('lesson-complete-screen');
            }

            // --- BUG FIX: แก้ไขฟังก์ชันนี้เพื่อแยกการทำงานระหว่าง touch และ mouse ---
            function createSquid(number, position = {}, animationClasses = 'spawn-anim') {
                const squidEl = document.createElement('div');
                squidEl.className = `squid ${animationClasses}`;
                squidEl.dataset.number = number;
                
                squidEl.innerHTML = `<span class="number-display">${number}</span>`;
                dom.squidArea.appendChild(squidEl);
                Object.assign(squidEl.style, position);

                // --- CONDITIONALLY ADD EVENT LISTENERS ---
                if (!isTouchDevice) {
                    // For desktop/mouse users, use the classic drag and drop
                    squidEl.draggable = true;
                    squidEl.addEventListener('dragstart', (e) => {
                        draggedElement = e.target.closest('.squid');
                        if(draggedElement) setTimeout(() => draggedElement.classList.add('dragging'), 0);
                    });
                    squidEl.addEventListener('dragend', () => {
                        if(draggedElement) draggedElement.classList.remove('dragging');
                    });
                }
                // For touch devices, the main `initializeTouchEvents` will handle everything.
                
                if (animationClasses.includes('float-up')) {
                    const difficultySettings = CAI_CONFIG.practice.challenge.difficulties[currentDifficulty];
                    squidEl.style.animationDuration = `${difficultySettings.floatDuration}s`;
                    squidEl.addEventListener('animationend', () => {
                        if (squidEl.parentElement === dom.squidArea) squidEl.remove();
                    });
                }
            }
            
            function handleAnswer(squidEl, grillId) {
                if (!isGameActive) return;
                isGameActive = false; 

                const num = parseInt(squidEl.dataset.number);
                const isCorrect = currentLesson.checkAnswer(num, grillId);
                
                if (isCorrect) {
                    correctAnswers++;
                    playSound('correct');
                    vibrate(100);
                    squidEl.classList.add('squid-correct');
                } else {
                    playSound('wrong');
                    vibrate([100, 50, 100]);
                    squidEl.classList.add('squid-wrong');
                }
                
                dom.feedback.innerHTML = currentLesson.getExplanation(num, isCorrect);
                updateHUD();
                
                squidEl.draggable = false;

                const delay = isCorrect ? 1500 : 500;
                setTimeout(() => {
                    isGameActive = true;
                     if(isCorrect) {
                        squidEl.remove();
                        nextQuestion();
                    } else {
                        squidEl.classList.remove('squid-wrong');
                        if (squidEl.parentNode !== dom.squidArea) {
                            dom.squidArea.appendChild(squidEl);
                        }
                        isGameActive = true; 
                    }
                }, delay);
            }
            
            function handlePracticeAnswer(squidEl, grillId) {
                if (!isGameActive) return;

                const num = parseInt(squidEl.dataset.number);
                const isEven = num % 2 === 0;
                const correct = (isEven && grillId === 'grill-1') || (!isEven && grillId === 'grill-2');
                squidEl.draggable = false;

                if (correct) {
                    score++;
                    playSound('correct');
                    vibrate(100);
                    squidEl.style.animation = 'none';
                    void squidEl.offsetWidth; 
                    squidEl.classList.add('squid-correct');
                    
                    setTimeout(() => squidEl.remove(), 1500);

                    if (currentGameMode === 'endless') {
                        isGameActive = false;
                        if(score > 0 && score % CAI_CONFIG.practice.endless.levelUpScore === 0){
                            level++;
                            timeLeft += CAI_CONFIG.practice.endless.timeBonus;
                            playSound('levelup');
                        }
                        setTimeout(() => {
                            isGameActive = true;
                            generateSquidEndless();
                        }, 500);
                    }
                } else {
                    playSound('wrong');
                    vibrate([100, 50, 100]);
                    squidEl.classList.add('squid-wrong');
                    setTimeout(() => {
                        squidEl.classList.remove('squid-wrong');
                        if (!isTouchDevice) {
                           squidEl.draggable = true;
                        }
                    }, 500);
                }
                
                updateHUD();
                const scoreContainer = document.getElementById('score-container');
                if (scoreContainer && correct) {
                    scoreContainer.classList.add('score-pop');
                    setTimeout(() => scoreContainer.classList.remove('score-pop'), 300);
                }
            }
            
            function generateSquidEndless() {
                if (!isGameActive) return;
                dom.squidArea.innerHTML = '';
                const number = Math.floor(Math.random() * (20 * Math.pow(level, 2))) + 1;
                createSquid(number); 
            }

            function scheduleNextSquid() {
                if (!isGameActive || timeLeft <= 0) return;

                const difficultySettings = CAI_CONFIG.practice.challenge.difficulties[currentDifficulty];
                const { minSpawn, maxSpawn } = difficultySettings;
                const nextSpawnTime = Math.random() * (maxSpawn - minSpawn) + minSpawn;

                spawnerTimeout = setTimeout(() => {
                    spawnSquidChallenge();
                    scheduleNextSquid();
                }, nextSpawnTime);
            }
            
            function spawnSquidChallenge() {
                if (!isGameActive) return;
                const config = CAI_CONFIG.practice.challenge;
                const numLanes = config.numLanes;
                const margin = config.horizontalMargin;
                const effectiveWidth = 100 - (margin * 2);
                const laneWidth = effectiveWidth / numLanes;
                
                const occupiedLanes = Array.from(dom.squidArea.querySelectorAll('.squid-absolute')).map(squid => {
                    const leftPercent = parseFloat(squid.style.left);
                    return Math.floor((leftPercent - margin) / laneWidth);
                });

                let availableLanes = Array.from({ length: numLanes }, (_, i) => i).filter(lane => !occupiedLanes.includes(lane));

                if (availableLanes.length === 0) return;

                const chosenLane = availableLanes[Math.floor(Math.random() * availableLanes.length)];
                const positionX = margin + (chosenLane * laneWidth) + (laneWidth / 2);

                const position = { left: `${positionX}%`, transform: 'translateX(-50%)' };
                createSquid(Math.floor(Math.random() * 1000) + 1, position, 'squid-absolute float-up');
            }

            function initializeDragDrop() {
                [dom.grill1, dom.grill2].forEach(grill => {
                    grill.addEventListener('dragover', e => { e.preventDefault(); if(isGameActive) grill.classList.add('drag-over'); });
                    grill.addEventListener('dragleave', () => grill.classList.remove('drag-over'));
                    grill.addEventListener('drop', e => {
                        e.preventDefault();
                        if (!draggedElement || !isGameActive) return;
                        grill.classList.remove('drag-over');
                        
                        if (currentGameMode === 'lesson') {
                            handleAnswer(draggedElement, e.currentTarget.id);
                        } else {
                            handlePracticeAnswer(draggedElement, e.currentTarget.id);
                        }
                        draggedElement = null;
                    });
                });
            }

            initializeGame();
        });
    </script>
</body>
</html>